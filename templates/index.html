{% extends "layout.html" %}

{% block content %}
<h1>Mood Journal</h1>

{% if not session.get('user') %}
  <p style="color: #ff69b4; font-weight:bold;">To save entries, please log in.</p>
{% endif %}

<form action="{{ url_for('save') }}" method="post" {% if not session.get('user') %}style="display:none;"{% endif %}>
  <h3>Select Your Mood:</h3>
  <div>
    {% for emo in emotions %}
      <label>
        <input type="radio" name="emotion" value="{{ emo }}" required hidden>
        <img src="{{ url_for('static', filename='images/' + emo + '.png') }}" class="mood-icon" onclick="selectIcon(this)">
      </label>
    {% endfor %}
  </div>

  <div class="note-box">
    <h3>Notes</h3>
    <textarea name="notes" rows="4" placeholder="Write your thoughts here..."></textarea>
  </div>

  <div class="plans-box">
    <h3>Plans for Today</h3>
    <div id="plan-list">
      <div class="plan-item">
        <input type="text" name="plans[]" placeholder="Write a plan">
      </div>
    </div>
    <button type="button" onclick="addPlan()">Add Another</button>
  </div>

  <br>
  <button type="submit">Save Entry</button>
</form>

<hr>

<h2>Previous Entries</h2>
{% for entry in entries %}
  {% set entry_id = loop.index0 %}
  <div class="entry">
    <div class="timestamp">{{ entry.timestamp }}</div>
    <div><strong>Mood:</strong> {{ entry.emotion }}</div>
    <div><strong>Notes:</strong> {{ entry.notes }}</div>
    <div><strong>Plans:</strong>
      <ul>
        {% for p in entry.plans %}
          {% set plan_index = loop.index0 %}
          <li>
            <input type="checkbox"
                   {% if p.done %}checked{% endif %}
                   onchange="toggleDone({{ entry_id }}, {{ plan_index }})">
            {{ p.text }}
          </li>
        {% endfor %}
      </ul>
    </div>
    <form action="{{ url_for('delete', entry_id=entry_id) }}" method="post" style="margin-top:10px;">
      <button type="submit" style="background-color:#ffb6c1; border:none; padding:5px 10px; border-radius:5px;">Delete</button>
    </form>
  </div>
{% endfor %}

<script>
  function addPlan() {
    const div = document.createElement('div');
    div.className = "plan-item";

    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'plans[]';
    input.placeholder = 'Write a plan';

    div.appendChild(input);
    document.getElementById('plan-list').appendChild(div);
  }

  function selectIcon(img) {
    document.querySelectorAll('.mood-icon').forEach(i => i.classList.remove('selected'));
    img.classList.add('selected');
    img.previousElementSibling.checked = true;
  }

  function toggleDone(entryId, planIndex) {
    fetch(`/toggle_done/${entryId}/${planIndex}`, {
      method: 'POST'
    }).then(response => {
      if (!response.ok) {
        alert("Failed to update plan status.");
      }
    });
  }
</script>
{% endblock %}

